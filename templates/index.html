<!DOCTYPE html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>每日出工統計表 </title>
  <style>
    /* ===== 基礎主題（支援深/淺色切換） ===== */
    :root{
      --bg:#0b1020; --bg2:#0f172a; --card:#0b1224cc; --card-solid:#0f172a;
      --text:#e6eaf3; --muted:#9aa7bd; --line:rgba(148,163,184,.18);
      --accent:#8b5cf6; --accent2:#06b6d4; --ring:#a78bfa; --ok:#10b981; --danger:#ef4444;
      --radius:16px; --shadow:0 14px 40px rgba(0,0,0,.40);
      --glass: saturate(130%) blur(10px);
    }
    [data-theme="light"]{
      --bg:#f7f8fb; --bg2:#eef1f6; --card:#ffffffdd; --card-solid:#fff;
      --text:#1b2430; --muted:#5b6b82; --line:rgba(0,0,0,.08);
      --accent:#7c3aed; --accent2:#0891b2; --ring:#8b5cf6; --ok:#059669; --danger:#dc2626;
      --shadow:0 20px 40px rgba(2,6,23,.12);
      --glass: saturate(120%) blur(6px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, var(--bg2) 10%, transparent 40%),
        radial-gradient(1000px 800px at 90% 10%, var(--bg) 10%, transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:32px; overflow-y:auto;
    }

    /* ===== 外框與頭區 ===== */
    .wrap{ width:min(980px, 100%); }
    .header{ display:flex; justify-content:space-between; gap:16px; align-items:flex-start; margin-bottom:16px; }
    .title{ margin:0; font-size:clamp(22px,2.8vw,36px); font-weight:800; letter-spacing:.3px;
      background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .subtitle{ margin:6px 0 0; color:var(--muted); font-size:14px }

    .actions{ display:flex; gap:8px; align-items:center; }
    .toggle{ appearance:none; position:relative; width:58px; height:32px; border-radius:999px; cursor:pointer; outline:none; border:1px solid var(--line); background:var(--card-solid); }
    .toggle:before{ content:""; position:absolute; top:3px; left:3px; width:26px; height:26px; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:50%; transition:transform .25s ease; }
    [data-theme="light"] .toggle:before{ transform:translateX(26px); }

    /* ===== 卡片 + 漸層邊框 ===== */
    .card{ position:relative; border-radius:var(--radius); overflow:hidden; }
    .card:before{ content:""; position:absolute; inset:0; padding:1px; border-radius:inherit; background:linear-gradient(120deg, transparent 20%, var(--accent) 40%, var(--accent2) 60%, transparent 80%); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; }
    .card-inner{ background:var(--card); backdrop-filter:var(--glass); border:1px solid var(--line); box-shadow:var(--shadow); border-radius:inherit; }

    /* ===== 表單佈局 ===== */
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; padding:22px; }
    @media (min-width: 760px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .field{ display:flex; flex-direction:column; gap:10px; }
    .label{ font-size:13px; color:var(--muted); letter-spacing:.2px }

    .control{ position:relative; }
    .input,.select{ width:100%; padding:14px 14px 14px 44px; background:var(--card-solid); border:1px solid var(--line); color:inherit; border-radius:12px; outline:none; transition:border .15s, box-shadow .15s, background .2s; }
    .select{ appearance:none; -webkit-appearance:none; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>'); background-repeat:no-repeat; background-position:right 12px center; padding-right:42px; }
    .input:focus,.select:focus{ border-color:var(--ring); box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 20%, transparent); }

    .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.85 }

    /* 浮動 label 效果 */
    .float{ position:relative; }
    .float input{ padding-top:22px; }
    .float label.floating{ position:absolute; left:44px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:14px; pointer-events:none; transition: all .15s ease; }
    .float input:not(:placeholder-shown) + label.floating,
    .float input:focus + label.floating{ top:8px; font-size:11px; color:var(--ring); }

    /* 段落 */
    .section{ border-top:1px solid var(--line); padding:18px 22px; }
    .section h3{ margin:0 0 12px; font-size:16px; color:color-mix(in oklab, var(--text) 80%, #fff 20%); }

    .rows{ display:flex; flex-direction:column; gap:10px }
    .row{ display:grid; grid-template-columns:2fr 2fr auto; gap:10px; align-items:center; padding:12px; background:var(--card-solid); border:1px solid var(--line); border-radius:12px; animation: pop .18s ease; }
    @keyframes pop{ from{ transform:scale(.98); opacity:.0 } to{ transform:scale(1); opacity:1 } }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btn{ border:none; padding:12px 16px; border-radius:12px; color:white; cursor:pointer; font-weight:700; letter-spacing:.2px; transition:transform .05s ease, filter .15s ease, opacity .2s; }
    .btn:active{ transform:translateY(1px) }
    .btn-ghost{ background:transparent; color:var(--accent2); border:1px dashed color-mix(in oklab, var(--accent2) 60%, transparent); }
    .btn-ghost:hover{ filter:brightness(1.1) }
    .btn-accent{ background:linear-gradient(92deg,var(--accent),var(--accent2)); box-shadow:0 6px 18px color-mix(in oklab, var(--accent) 30%, transparent); }
    .btn-accent:hover{ filter:brightness(1.05) }
    .btn-danger{ background:color-mix(in oklab, var(--danger) 16%, transparent); color:color-mix(in oklab, var(--danger) 70%, #fff); border:1px solid color-mix(in oklab, var(--danger) 35%, transparent); }

    .footer{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 22px; border-top:1px solid var(--line); }
    .hint{ color:var(--muted); font-size:12px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:2px 6px; border-radius:6px; background:#111827; border:1px solid var(--line); color:#e5e7eb }

    /* 資訊條 */
    .infobar{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--card-solid); }

    /* Toast */
    .toast{ position:fixed; right:18px; bottom:18px; background:var(--card-solid); border:1px solid var(--line); border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition: all .25s ease; }
    .toast.show{ opacity:1; transform:none; }

    /* 工號錯誤樣式（前端檢查用） */
    .input.invalid{ border-color: color-mix(in oklab, var(--danger) 50%, transparent); box-shadow:0 0 0 4px color-mix(in oklab, var(--danger) 20%, transparent); }
    .err-msg{ color: color-mix(in oklab, var(--danger) 75%, #fff); font-size:12px; margin:4px 0 0 44px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">每日出工統計表 </h1>
        <p class="subtitle">填寫天氣、移工管理員與缺勤名單 送出後將自動產生 Excel </p>
      </div>
      <div class="actions">
        <span class="infobar">
          <span class="badge" id="dateBadge">日期：—</span>
          <span class="badge" id="countBadge">名單數：1</span>
        </span>
        <input class="toggle" id="themeToggle" type="checkbox" title="切換淺色/深色" />
      </div>
    </div>

    <div class="card"><div class="card-inner">
      <form method="POST" action="/" id="mainForm">
        <div class="grid">
          <div class="field">
            <span class="label">天氣</span>
            <div class="control">
              <span class="icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
              </span>
              <select id="weather" name="weather" class="select" required>
                <option value="" disabled selected>請選擇天氣</option>
                <option value="晴">☀️ 晴</option>
                <option value="陰">☁️ 陰</option>
                <option value="雨">🌧️ 雨</option>
              </select>
            </div>
          </div>

          <div class="field">
            <span class="label">移工管理員</span>
            <div class="control">
              <span class="icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/>
                </svg>
              </span>
              <select id="manager" name="manager" class="select">
                <option value="">請選擇管理員</option>
                {% for m in managers %}
                  <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

        <div class="section">
          <h3>缺勤名單</h3>
          <div class="rows" id="rows">
            <div class="row">
              <div class="control float">
                <!-- 工號：純數字 + 即時淨化 + 前端檢查 -->
                <input name="emp_id"
                       class="input emp-input"
                       placeholder=" "
                       required
                       inputmode="numeric"
                       pattern="\d+"
                       title="工號僅允許數字"
                       oninput="this.value=this.value.replace(/\D/g,'')" />
                <label class="floating">工號，例如：22666</label>
                <span class="icon" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                </span>
                <div class="err-msg" style="display:none;"></div>
              </div>
              <div class="control">
                <span class="icon" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
                </span>
                <select name="reason" class="select" required>
                  {% for r in reasons %}
                    <option>{{ r }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="btn btn-danger" onclick="removeRow(this)" title="刪除此列">刪除</button>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button type="button" class="btn btn-ghost" onclick="addRow()">＋ 新增一列</button>
          </div>
        </div>

        <div class="footer">
          <span class="hint">小技巧：按 <span class="kbd">Tab</span> 可快速跳到下一欄位。</span>
          <button type="submit" class="btn btn-accent">🚀 產生出工表</button>
        </div>
      </form>
    </div></div>
  </div>

  <!-- 讓 JS 能複製相同的原因選項（Jinja 渲染一次） -->
  <template id="reasonOptions">
    {% for r in reasons %}
      <option>{{ r }}</option>
    {% endfor %}
  </template>

  <div class="toast" id="toast"></div>

  <script>
    // ✅ 從後端注入的有效工號清單（請在 render_template 傳入 valid_emp_ids）
    const VALID_IDS = new Set({{ valid_emp_ids|tojson|safe }});

    // 日期徽章
    const dateBadge = document.getElementById('dateBadge');
    const today = new Date();
    const weekday = ['日','一','二','三','四','五','六'][today.getDay()];
    dateBadge.textContent = `日期：${today.getFullYear()}年${String(today.getMonth()+1).padStart(2,'0')}月${String(today.getDate()).padStart(2,'0')}日（週${weekday}）`;

    // 顯示/隱藏 Toast
    function showToast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>el.classList.remove('show'), 2300);
    }

    // 列計數徽章
    const countBadge = document.getElementById('countBadge');
    function updateCount(){
      const rows = document.querySelectorAll('#rows .row').length;
      countBadge.textContent = `名單數：${rows}`;
    }

    // 綁定工號欄位檢查（數字 + 是否存在）
    function bindEmpCheck(input){
      const err = input.closest('.control').querySelector('.err-msg');
      function validate(){
        const v = (input.value || '').trim();
        input.classList.remove('invalid');
        err.style.display = 'none';
        err.textContent = '';

        if (!v) return true;              // 允許空白交給 required 控制
        if (!/^\d+$/.test(v)){            // 非數字
          input.classList.add('invalid');
          err.textContent = '工號僅允許數字';
          err.style.display = 'block';
          return false;
        }
        if (!VALID_IDS.has(v)){           // 不存在
          input.classList.add('invalid');
          err.textContent = `工號不存在：${v}`;
          err.style.display = 'block';
          return false;
        }
        return true;
      }
      input.addEventListener('blur', validate);
      input.addEventListener('input', ()=>{ // 即時清錯
        input.classList.remove('invalid');
        err.style.display = 'none';
        err.textContent = '';
      });
      return validate;
    }

    // 動態新增/刪除列（用 template 取 Jinja 渲染的 options）
    function addRow(){
      const rows = document.getElementById('rows');
      const options = document.getElementById('reasonOptions').innerHTML;
      const div = document.createElement('div');
      div.className='row';
      div.innerHTML = `
        <div class="control float">
          <input name="emp_id"
                 class="input emp-input"
                 placeholder=" "
                 required
                 inputmode="numeric"
                 pattern="\\d+"
                 title="工號僅允許數字"
                 oninput="this.value=this.value.replace(/\\D/g,'')" />
          <label class="floating">工號，例如：22666</label>
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
          </span>
          <div class="err-msg" style="display:none;"></div>
        </div>
        <div class="control">
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
          </span>
          <select name="reason" class="select" required>` + options + `</select>
        </div>
        <button type="button" class="btn btn-danger" onclick="removeRow(this)" title="刪除此列">刪除</button>`;
      rows.appendChild(div);
      // 綁定新欄位檢查
      const input = div.querySelector('.emp-input');
      bindEmpCheck(input);
      updateCount();
    }
    function removeRow(btn){ btn.closest('.row').remove(); updateCount(); }
    updateCount();

    // 綁定現有第一列的工號檢查
    document.querySelectorAll('.emp-input').forEach(bindEmpCheck);

    // 表單提交前總驗證（擋送出）
    document.getElementById('mainForm').addEventListener('submit', function(e){
      const inputs = Array.from(document.querySelectorAll('.emp-input'));
      let ok = true, firstBad = null;

      for (const input of inputs){
        // 呼叫每個欄位綁定的 validate（若沒綁，做一次性檢查）
        const v = (input.value || '').trim();
        let pass = true;
        if (!/^\d+$/.test(v)){
          pass = false;
          input.classList.add('invalid');
          const err = input.closest('.control').querySelector('.err-msg');
          err.textContent = v ? '工號僅允許數字' : '請填寫工號';
          err.style.display = 'block';
        } else if (!VALID_IDS.has(v)){
          pass = false;
          input.classList.add('invalid');
          const err = input.closest('.control').querySelector('.err-msg');
          err.textContent = `工號不存在：${v}`;
          err.style.display = 'block';
        }
        if (!pass && ok){
          ok = false;
          firstBad = input;
        }
      }

      if (!ok){
        e.preventDefault();
        if (firstBad) firstBad.focus();
        showToast('請修正紅框工號（僅數字，且需存在於名冊）');
      }
    });

    // 主題切換
    const toggle = document.getElementById('themeToggle');
    toggle.addEventListener('change', ()=>{
      document.documentElement.setAttribute('data-theme', toggle.checked ? 'light' : 'dark');
    });
  </script>
</body>
</html>
