<!DOCTYPE html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¯æ—¥å‡ºå·¥çµ±è¨ˆè¡¨ </title>
  <style>
    /* ===== åŸºç¤ä¸»é¡Œï¼ˆæ”¯æ´æ·±/æ·ºè‰²åˆ‡æ›ï¼‰ ===== */
    :root{
      --bg:#0b1020; --bg2:#0f172a; --card:#0b1224cc; --card-solid:#0f172a;
      --text:#e6eaf3; --muted:#9aa7bd; --line:rgba(148,163,184,.18);
      --accent:#8b5cf6; --accent2:#06b6d4; --ring:#a78bfa; --ok:#10b981; --danger:#ef4444;
      --radius:16px; --shadow:0 14px 40px rgba(0,0,0,.40);
      --glass: saturate(130%) blur(10px);
    }
    [data-theme="light"]{
      --bg:#f7f8fb; --bg2:#eef1f6; --card:#ffffffdd; --card-solid:#fff;
      --text:#1b2430; --muted:#5b6b82; --line:rgba(0,0,0,.08);
      --accent:#7c3aed; --accent2:#0891b2; --ring:#8b5cf6; --ok:#059669; --danger:#dc2626;
      --shadow:0 20px 40px rgba(2,6,23,.12);
      --glass: saturate(120%) blur(6px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, var(--bg2) 10%, transparent 40%),
        radial-gradient(1000px 800px at 90% 10%, var(--bg) 10%, transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:32px; overflow-y:auto;
    }

    /* ===== å¤–æ¡†èˆ‡é ­å€ ===== */
    .wrap{ width:min(980px, 100%); }
    .header{ display:flex; justify-content:space-between; gap:16px; align-items:flex-start; margin-bottom:16px; }
    .title{ margin:0; font-size:clamp(22px,2.8vw,36px); font-weight:800; letter-spacing:.3px;
      background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .subtitle{ margin:6px 0 0; color:var(--muted); font-size:14px }

    .actions{ display:flex; gap:8px; align-items:center; }
    .toggle{ appearance:none; position:relative; width:58px; height:32px; border-radius:999px; cursor:pointer; outline:none; border:1px solid var(--line); background:var(--card-solid); }
    .toggle:before{ content:""; position:absolute; top:3px; left:3px; width:26px; height:26px; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:50%; transition:transform .25s ease; }
    [data-theme="light"] .toggle:before{ transform:translateX(26px); }

    /* ===== å¡ç‰‡ + æ¼¸å±¤é‚Šæ¡† ===== */
    .card{ position:relative; border-radius:var(--radius); overflow:hidden; }
    .card:before{ content:""; position:absolute; inset:0; padding:1px; border-radius:inherit; background:linear-gradient(120deg, transparent 20%, var(--accent) 40%, var(--accent2) 60%, transparent 80%); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none; }
    .card-inner{ background:var(--card); backdrop-filter:var(--glass); border:1px solid var(--line); box-shadow:var(--shadow); border-radius:inherit; }

    /* ===== è¡¨å–®ä½ˆå±€ ===== */
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; padding:22px; }
    @media (min-width: 760px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .field{ display:flex; flex-direction:column; gap:10px; }
    .label{ font-size:13px; color:var(--muted); letter-spacing:.2px }

    .control{ position:relative; }
    .input,.select{ width:100%; padding:14px 14px 14px 44px; background:var(--card-solid); border:1px solid var(--line); color:inherit; border-radius:12px; outline:none; transition:border .15s, box-shadow .15s, background .2s; }
    .select{ appearance:none; -webkit-appearance:none; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>'); background-repeat:no-repeat; background-position:right 12px center; padding-right:42px; }
    .input:focus,.select:focus{ border-color:var(--ring); box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 20%, transparent); }

    .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.85 }

    /* æµ®å‹• label æ•ˆæœ */
    .float{ position:relative; }
    .float input{ padding-top:22px; }
    .float label.floating{ position:absolute; left:44px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:14px; pointer-events:none; transition: all .15s ease; }
    .float input:not(:placeholder-shown) + label.floating,
    .float input:focus + label.floating{ top:8px; font-size:11px; color:var(--ring); }

    /* æ®µè½ */
    .section{ border-top:1px solid var(--line); padding:18px 22px; }
    .section h3{ margin:0 0 12px; font-size:16px; color:color-mix(in oklab, var(--text) 80%, #fff 20%); }

    .rows{ display:flex; flex-direction:column; gap:10px }
    .row{ display:grid; grid-template-columns:2fr 2fr auto; gap:10px; align-items:center; padding:12px; background:var(--card-solid); border:1px solid var(--line); border-radius:12px; animation: pop .18s ease; }
    @keyframes pop{ from{ transform:scale(.98); opacity:.0 } to{ transform:scale(1); opacity:1 } }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btn{ border:none; padding:12px 16px; border-radius:12px; color:white; cursor:pointer; font-weight:700; letter-spacing:.2px; transition:transform .05s ease, filter .15s ease, opacity .2s; }
    .btn:active{ transform:translateY(1px) }
    .btn-ghost{ background:transparent; color:var(--accent2); border:1px dashed color-mix(in oklab, var(--accent2) 60%, transparent); }
    .btn-ghost:hover{ filter:brightness(1.1) }
    .btn-accent{ background:linear-gradient(92deg,var(--accent),var(--accent2)); box-shadow:0 6px 18px color-mix(in oklab, var(--accent) 30%, transparent); }
    .btn-accent:hover{ filter:brightness(1.05) }
    .btn-danger{ background:color-mix(in oklab, var(--danger) 16%, transparent); color:color-mix(in oklab, var(--danger) 70%, #fff); border:1px solid color-mix(in oklab, var(--danger) 35%, transparent); }

    .footer{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 22px; border-top:1px solid var(--line); }
    .hint{ color:var(--muted); font-size:12px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:2px 6px; border-radius:6px; background:#111827; border:1px solid var(--line); color:#e5e7eb }

    /* è³‡è¨Šæ¢ */
    .infobar{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--card-solid); }

    /* Toast */
    .toast{ position:fixed; right:18px; bottom:18px; background:var(--card-solid); border:1px solid var(--line); border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition: all .25s ease; }
    .toast.show{ opacity:1; transform:none; }

    /* å·¥è™ŸéŒ¯èª¤æ¨£å¼ï¼ˆå‰ç«¯æª¢æŸ¥ç”¨ï¼‰ */
    .input.invalid{ border-color: color-mix(in oklab, var(--danger) 50%, transparent); box-shadow:0 0 0 4px color-mix(in oklab, var(--danger) 20%, transparent); }
    .err-msg{ color: color-mix(in oklab, var(--danger) 75%, #fff); font-size:12px; margin:4px 0 0 44px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">æ¯æ—¥å‡ºå·¥çµ±è¨ˆè¡¨ </h1>
        <p class="subtitle">å¡«å¯«å¤©æ°£ã€ç§»å·¥ç®¡ç†å“¡èˆ‡ç¼ºå‹¤åå–® é€å‡ºå¾Œå°‡è‡ªå‹•ç”¢ç”Ÿ Excel </p>
      </div>
      <div class="actions">
        <span class="infobar">
          <span class="badge" id="dateBadge">æ—¥æœŸï¼šâ€”</span>
          <span class="badge" id="countBadge">åå–®æ•¸ï¼š1</span>
        </span>
        <input class="toggle" id="themeToggle" type="checkbox" title="åˆ‡æ›æ·ºè‰²/æ·±è‰²" />
      </div>
    </div>

    <div class="card"><div class="card-inner">
      <form method="POST" action="/" id="mainForm">
        <div class="grid">
          <div class="field">
            <span class="label">å¤©æ°£</span>
            <div class="control">
              <span class="icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
              </span>
              <select id="weather" name="weather" class="select" required>
                <option value="" disabled selected>è«‹é¸æ“‡å¤©æ°£</option>
                <option value="æ™´">â˜€ï¸ æ™´</option>
                <option value="é™°">â˜ï¸ é™°</option>
                <option value="é›¨">ğŸŒ§ï¸ é›¨</option>
              </select>
            </div>
          </div>

          <div class="field">
            <span class="label">ç§»å·¥ç®¡ç†å“¡</span>
            <div class="control">
              <span class="icon" aria-hidden="true">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/>
                </svg>
              </span>
              <select id="manager" name="manager" class="select">
                <option value="">è«‹é¸æ“‡ç®¡ç†å“¡</option>
                {% for m in managers %}
                  <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

        <div class="section">
          <h3>ç¼ºå‹¤åå–®</h3>
          <div class="rows" id="rows">
            <div class="row">
              <div class="control float">
                <!-- å·¥è™Ÿï¼šç´”æ•¸å­— + å³æ™‚æ·¨åŒ– + å‰ç«¯æª¢æŸ¥ -->
                <input name="emp_id"
                       class="input emp-input"
                       placeholder=" "
                       required
                       inputmode="numeric"
                       pattern="\d+"
                       title="å·¥è™Ÿåƒ…å…è¨±æ•¸å­—"
                       oninput="this.value=this.value.replace(/\D/g,'')" />
                <label class="floating">å·¥è™Ÿï¼Œä¾‹å¦‚ï¼š22666</label>
                <span class="icon" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                </span>
                <div class="err-msg" style="display:none;"></div>
              </div>
              <div class="control">
                <span class="icon" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
                </span>
                <select name="reason" class="select" required>
                  {% for r in reasons %}
                    <option>{{ r }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="btn btn-danger" onclick="removeRow(this)" title="åˆªé™¤æ­¤åˆ—">åˆªé™¤</button>
            </div>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button type="button" class="btn btn-ghost" onclick="addRow()">ï¼‹ æ–°å¢ä¸€åˆ—</button>
          </div>
        </div>

        <div class="footer">
          <span class="hint">å°æŠ€å·§ï¼šæŒ‰ <span class="kbd">Tab</span> å¯å¿«é€Ÿè·³åˆ°ä¸‹ä¸€æ¬„ä½ã€‚</span>
          <button type="submit" class="btn btn-accent">ğŸš€ ç”¢ç”Ÿå‡ºå·¥è¡¨</button>
        </div>
      </form>
    </div></div>
  </div>

  <!-- è®“ JS èƒ½è¤‡è£½ç›¸åŒçš„åŸå› é¸é …ï¼ˆJinja æ¸²æŸ“ä¸€æ¬¡ï¼‰ -->
  <template id="reasonOptions">
    {% for r in reasons %}
      <option>{{ r }}</option>
    {% endfor %}
  </template>

  <div class="toast" id="toast"></div>

  <script>
    // âœ… å¾å¾Œç«¯æ³¨å…¥çš„æœ‰æ•ˆå·¥è™Ÿæ¸…å–®ï¼ˆè«‹åœ¨ render_template å‚³å…¥ valid_emp_idsï¼‰
    const VALID_IDS = new Set({{ valid_emp_ids|tojson|safe }});

    // æ—¥æœŸå¾½ç« 
    const dateBadge = document.getElementById('dateBadge');
    const today = new Date();
    const weekday = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()];
    dateBadge.textContent = `æ—¥æœŸï¼š${today.getFullYear()}å¹´${String(today.getMonth()+1).padStart(2,'0')}æœˆ${String(today.getDate()).padStart(2,'0')}æ—¥ï¼ˆé€±${weekday}ï¼‰`;

    // é¡¯ç¤º/éš±è— Toast
    function showToast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>el.classList.remove('show'), 2300);
    }

    // åˆ—è¨ˆæ•¸å¾½ç« 
    const countBadge = document.getElementById('countBadge');
    function updateCount(){
      const rows = document.querySelectorAll('#rows .row').length;
      countBadge.textContent = `åå–®æ•¸ï¼š${rows}`;
    }

    // ç¶å®šå·¥è™Ÿæ¬„ä½æª¢æŸ¥ï¼ˆæ•¸å­— + æ˜¯å¦å­˜åœ¨ï¼‰
    function bindEmpCheck(input){
      const err = input.closest('.control').querySelector('.err-msg');
      function validate(){
        const v = (input.value || '').trim();
        input.classList.remove('invalid');
        err.style.display = 'none';
        err.textContent = '';

        if (!v) return true;              // å…è¨±ç©ºç™½äº¤çµ¦ required æ§åˆ¶
        if (!/^\d+$/.test(v)){            // éæ•¸å­—
          input.classList.add('invalid');
          err.textContent = 'å·¥è™Ÿåƒ…å…è¨±æ•¸å­—';
          err.style.display = 'block';
          return false;
        }
        if (!VALID_IDS.has(v)){           // ä¸å­˜åœ¨
          input.classList.add('invalid');
          err.textContent = `å·¥è™Ÿä¸å­˜åœ¨ï¼š${v}`;
          err.style.display = 'block';
          return false;
        }
        return true;
      }
      input.addEventListener('blur', validate);
      input.addEventListener('input', ()=>{ // å³æ™‚æ¸…éŒ¯
        input.classList.remove('invalid');
        err.style.display = 'none';
        err.textContent = '';
      });
      return validate;
    }

    // å‹•æ…‹æ–°å¢/åˆªé™¤åˆ—ï¼ˆç”¨ template å– Jinja æ¸²æŸ“çš„ optionsï¼‰
    function addRow(){
      const rows = document.getElementById('rows');
      const options = document.getElementById('reasonOptions').innerHTML;
      const div = document.createElement('div');
      div.className='row';
      div.innerHTML = `
        <div class="control float">
          <input name="emp_id"
                 class="input emp-input"
                 placeholder=" "
                 required
                 inputmode="numeric"
                 pattern="\\d+"
                 title="å·¥è™Ÿåƒ…å…è¨±æ•¸å­—"
                 oninput="this.value=this.value.replace(/\\D/g,'')" />
          <label class="floating">å·¥è™Ÿï¼Œä¾‹å¦‚ï¼š22666</label>
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
          </span>
          <div class="err-msg" style="display:none;"></div>
        </div>
        <div class="control">
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
          </span>
          <select name="reason" class="select" required>` + options + `</select>
        </div>
        <button type="button" class="btn btn-danger" onclick="removeRow(this)" title="åˆªé™¤æ­¤åˆ—">åˆªé™¤</button>`;
      rows.appendChild(div);
      // ç¶å®šæ–°æ¬„ä½æª¢æŸ¥
      const input = div.querySelector('.emp-input');
      bindEmpCheck(input);
      updateCount();
    }
    function removeRow(btn){ btn.closest('.row').remove(); updateCount(); }
    updateCount();

    // ç¶å®šç¾æœ‰ç¬¬ä¸€åˆ—çš„å·¥è™Ÿæª¢æŸ¥
    document.querySelectorAll('.emp-input').forEach(bindEmpCheck);

    // è¡¨å–®æäº¤å‰ç¸½é©—è­‰ï¼ˆæ“‹é€å‡ºï¼‰
    document.getElementById('mainForm').addEventListener('submit', function(e){
      const inputs = Array.from(document.querySelectorAll('.emp-input'));
      let ok = true, firstBad = null;

      for (const input of inputs){
        // å‘¼å«æ¯å€‹æ¬„ä½ç¶å®šçš„ validateï¼ˆè‹¥æ²’ç¶ï¼Œåšä¸€æ¬¡æ€§æª¢æŸ¥ï¼‰
        const v = (input.value || '').trim();
        let pass = true;
        if (!/^\d+$/.test(v)){
          pass = false;
          input.classList.add('invalid');
          const err = input.closest('.control').querySelector('.err-msg');
          err.textContent = v ? 'å·¥è™Ÿåƒ…å…è¨±æ•¸å­—' : 'è«‹å¡«å¯«å·¥è™Ÿ';
          err.style.display = 'block';
        } else if (!VALID_IDS.has(v)){
          pass = false;
          input.classList.add('invalid');
          const err = input.closest('.control').querySelector('.err-msg');
          err.textContent = `å·¥è™Ÿä¸å­˜åœ¨ï¼š${v}`;
          err.style.display = 'block';
        }
        if (!pass && ok){
          ok = false;
          firstBad = input;
        }
      }

      if (!ok){
        e.preventDefault();
        if (firstBad) firstBad.focus();
        showToast('è«‹ä¿®æ­£ç´…æ¡†å·¥è™Ÿï¼ˆåƒ…æ•¸å­—ï¼Œä¸”éœ€å­˜åœ¨æ–¼åå†Šï¼‰');
      }
    });

    // ä¸»é¡Œåˆ‡æ›
    const toggle = document.getElementById('themeToggle');
    toggle.addEventListener('change', ()=>{
      document.documentElement.setAttribute('data-theme', toggle.checked ? 'light' : 'dark');
    });
  </script>
</body>
</html>
